pipeline {
    agent any

    environment {
        GOOGLE_APPLICATION_CREDENTIALS = credentials('new-project-1')
        PROJECT_ID = 'new-project-399404'
        REGION = 'us-central1'  // Change to your preferred region
        IMAGE_NAME = 'docker-repo/backend-1'
        IMAGE_TAG = 'v2'
    }

    stages {
        stage("Remove dir") {
            steps {
                deleteDir()
            }
        }
        stage("Print Git Info") {
            steps {
                    echo "Commit SHA1: ${env.GIT_COMMIT}"
                    echo "Branch: ${env.GIT_BRANCH}"
                    echo "Repository URL: ${env.GIT_URL}"
                    echo "Author Email: ${env.GIT_AUTHOR_EMAIL}"
                }    
        }

        stage("Clone") {
            steps {
                sh "git clone https://github.com/madhuri2604/docker-backend.git"    
            }
        }
        
        stage("approval") {
            options {
                timeout(time: 1, unit: 'MINUTES')
            }
            steps {
                input message: "Please approve to proceed with deployment", submitter: "your-approver-user"
            }
        }

        stage('Build and Push Docker Image') {
            steps {
                dir("docker-backend") {
                    script {
                        sh "gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS"
                        sh "gcloud config set project $PROJECT_ID"
                        sh "gcloud auth configure-docker $REGION-docker.pkg.dev --quiet"
                        sh "sudo docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$IMAGE_NAME:$IMAGE_TAG ."
                        sh "sudo docker push $REGION-docker.pkg.dev/$PROJECT_ID/$IMAGE_NAME:$IMAGE_TAG"
                    }
                }
            }
        }
    }
}
